<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CaptureFlow WebUI</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #container { display: flex; height: 100vh; }
    #search-pane { width: 200px; padding: 1rem; border-right: 1px solid #ddd; }
    #tree-pane { width: 300px; padding: 1rem; border-right: 1px solid #ddd; overflow-y: auto; }
    #image-pane { flex: 1; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    #image-pane img { max-width: 100%; max-height: 80vh; }
    #nav-buttons { margin-top: 1rem; }
    li { cursor: pointer; margin: 2px 0; }
    .selected { background: #e0e0ff; }
  </style>
</head>
<body>
  <div id="container">
    <div id="search-pane">
      <input type="text" id="search-box" placeholder="搜尋關鍵字">
      <button onclick="doSearch()">搜尋</button>
      <ul id="search-results"></ul>
    </div>
    <div id="tree-pane"></div>
    <div id="image-pane">
      <img id="main-image" src="" alt="" />
      <div id="nav-buttons">
        <button onclick="prevImage()">上一張</button>
        <button onclick="nextImage()">下一張</button>
      </div>
    </div>
  </div>
  <script>
  let treeData = {};
  let currentList = [];
  let currentIndex = -1;
  let selectedDateLi = null;
  let selectedResultLi = null;

  function loadTree() {
    fetch('/api/tree').then(r => r.json()).then(data => { treeData = data; renderTree(); });
  }

  function renderTree() {
    const treePane = document.getElementById('tree-pane');
    treePane.innerHTML = '';
    for (const pc in treeData) {
      const pcDiv = document.createElement('div');
      pcDiv.innerHTML = `<strong>${pc}</strong>`;
      const dateList = document.createElement('ul');
      for (const date in treeData[pc]) {
        const dateLi = document.createElement('li');
        dateLi.textContent = date;
        dateLi.onclick = () => selectImages(treeData[pc][date], dateLi);
        dateList.appendChild(dateLi);
      }
      pcDiv.appendChild(dateList);
      treePane.appendChild(pcDiv);
    }
  }

  function selectImages(imgList, elem) {
    currentList = imgList;
    currentIndex = 0;
    if (selectedDateLi) selectedDateLi.classList.remove('selected');
    if (elem) { elem.classList.add('selected'); selectedDateLi = elem; }
    displayImage();
  }

  function displayImage() {
    const img = document.getElementById('main-image');
    if (currentList.length === 0) { img.src = ''; return; }
    img.src = '/static/' + currentList[currentIndex].path;
  }

  function prevImage() {
    if (currentList.length === 0) return;
    currentIndex = (currentIndex - 1 + currentList.length) % currentList.length;
    displayImage();
  }

  function nextImage() {
    if (currentList.length === 0) return;
    currentIndex = (currentIndex + 1) % currentList.length;
    displayImage();
  }

  function doSearch() {
    const q = document.getElementById('search-box').value;
    fetch('/api/search?q=' + encodeURIComponent(q)).then(r => r.json()).then(results => {
      const list = document.getElementById('search-results');
      list.innerHTML = '';
      if (results.length === 0) {
        const empty = document.createElement('li');
        empty.textContent = '沒有結果';
        list.appendChild(empty);
      }
      results.forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.pc} ${r.date} ${r.text}`;
        li.onclick = () => {
          currentList = [{id:r.id, path:r.path}];
          currentIndex = 0;
          if (selectedResultLi) selectedResultLi.classList.remove('selected');
          li.classList.add('selected');
          selectedResultLi = li;
          displayImage();
        };
        list.appendChild(li);
      });
    });
  }

  loadTree();
  document.getElementById('search-box').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doSearch();
  });
  </script>
</body>
</html>
